name: Deploy to Render

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      deployments: write # Required for GitHub deployment status
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Deploy to Render
        uses: johnbeynon/render-deploy-action@v0.0.8
        with:
          service-id: ${{ secrets.RENDER_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}
          wait-for-success: true
      
      - name: Verify Backend Health
        run: |
          echo "üîç Verifying backend health..."
          MAX_ATTEMPTS=10
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://haven-new.onrender.com/health || echo "000")
            
            if [ "$STATUS_CODE" = "200" ]; then
              echo "‚úÖ Backend is healthy and responding!"
              exit 0
            fi
            
            echo "‚è≥ Attempt $((ATTEMPT+1))/$MAX_ATTEMPTS: Status $STATUS_CODE, waiting..."
            sleep 10
            ATTEMPT=$((ATTEMPT+1))
          done
          
          echo "‚ö†Ô∏è  Health check timed out, but deployment may still be starting"
          exit 0
      
      - name: Notify Success
        if: success()
        run: |
          echo "::notice::‚úÖ Backend deployed and healthy at https://haven-new.onrender.com"
      
      - name: Notify Failure
        if: failure()
        run: |
          echo "::error::‚ùå Render deployment failed. Check dashboard: https://dashboard.render.com"
